# to use the env-var "GIT_CLONE_PATH", set the following in
# ./gitlab-runner/config.toml under [[runners]]:
#   [runners.custom_build_dir]
#     enabled = true
# This will prevent git clone conflicts for jobs ran in parallel

stages:
  - info
  - test
  - deploy

workflow:
  rules:
    - if: $CI_COMMIT_REF_NAME =~ /-wip$/
      when: never
    - when: always

variables:
  GIT_CLONE_PATH: $CI_BUILDS_DIR/$CI_RUNNER_SHORT_TOKEN/$CI_PROJECT_PATH/$CI_COMMIT_REF_NAME/$CI_JOB_NAME/$CI_CONCURRENT_ID
  MAKE_FLAGS: -j 4

show-env-vars:
  stage: info
  variables:
    SEP: "##################################################################"
    S00: "commit date - "
    S01: "project: ${CI_PROJECT_PATH}"
    S02: "branch: ${CI_COMMIT_REF_NAME}"
    S03: "commit: ${CI_COMMIT_SHA}"
    S04: "commit msg: ${CI_COMMIT_MESSAGE}"
    S05: "clone base path: "
    S06: "runner token: ${CI_RUNNER_SHORT_TOKEN}"
  script:
    - echo -e "${SEP}\n${S00}$(date)\n${SEP}\n${S01}\n${S02}\n${S03}\n${S04}\n${SEP}\n${S05}${GIT_CLONE_PATH}\n${S06}\n${SEP}"

documentation:
  only:
    - develop
  stage: test
  variables:
    GIT_CLONE_PATH: $CI_BUILDS_DIR/$CI_RUNNER_SHORT_TOKEN/$CI_PROJECT_PATH/$CI_COMMIT_REF_NAME/$CI_JOB_NAME
    GIT_FETCH_EXTRA_FLAGS: --all --prune --quiet
  script:
    - module load foss/2019b
    - module load texlive/2019
    - module load Graphviz/2.42.2
    - module load Anaconda3
    - source activate /global/apps/mhm_checks/mhm_env
    # use doxygen from the mhm_env conda environment
    - doxygen doc/doxygen.config > doxygen_log_dev.txt
    # create pdf documentation
    - cd latex/ && make > ../doxygen_latex_dev.txt
    - cp refman.pdf ../html/forces_doc.pdf
    - cp refman.pdf ../forces_doc_dev.pdf
    - cd .. && mv html html_dev
    - mv doxygen_warn.txt doxygen_warn_dev.txt
    - rm -rf latex
    # same for master
    - git checkout master
    - doxygen doc/doxygen.config > doxygen_log_mas.txt
    - cd latex/ && make > ../doxygen_latex_mas.txt
    - cp refman.pdf ../html/forces_doc.pdf
    - cp refman.pdf ../forces_doc_mas.pdf
    - cd .. && mv html html_mas
  artifacts:
    name: "$CI_COMMIT_REF_NAME"
    paths:
      - html_dev
      - forces_doc_dev.pdf
      - doxygen_log_dev.txt
      - doxygen_latex_dev.txt
      - doxygen_warn_dev.txt
      - html_mas
      - forces_doc_mas.pdf
      - doxygen_log_mas.txt
      - doxygen_latex_mas.txt
      - doxygen_warn_mas.txt
  when: always

# how the job build directory is erected
.setup_build: &setup_build_dir
  - mkdir -p $BUILD_DIR
  - cd $BUILD_DIR

# make command
.make: &make
  - make $MAKE_FLAGS

# make test command
.make_test: &make_test
  - make $MAKE_FLAGS test

# make coverage command
.make_coverage: &make_coverage
  - make $MAKE_FLAGS FORCES_coverage_CI

# cleanup after scripts
.cleanup: &cleanup
  - cd -

# waiting on https://gitlab.com/groups/gitlab-org/-/epics/3589
# until this is fixed, we need to additionally set the CMAKE_FLAGS in the jobs as the expansion does not work
# debug variables
.debug_vars: &debug_vars
  BUILD_DIR: build_debug
  CMAKE_FLAGS: '$CMAKE_FLAGS -DBUILD_TESTING=ON -DCMAKE_BUILD_TYPE=Debug'

# release variables
.release_vars: &release_vars
  BUILD_DIR: build_release
  CMAKE_FLAGS: '$CMAKE_FLAGS -DBUILD_TESTING=ON -DCMAKE_BUILD_TYPE=Release'

# coverage variables
.coverage_vars: &coverage_vars
  CMAKE_FLAGS: '$CMAKE_FLAGS -DBUILD_TESTING=ON -DCMAKE_WITH_COVERAGE=ON'

# #################
# ### TEMPLATES ###
# #################

# template for test jobs
.test_template: &test_template
  stage: test
  script:
    - source $MODULE_LOAD_SCRIPT
    - *setup_build_dir
    - cmake $CMAKE_FLAGS ..
    - *make
    - *make_test
    - *cleanup
  artifacts:
    when: always
    paths:
    - $BUILD_DIR/Testing/Temporary

# template for coverage jobs
# .coverage_template: &coverage_template
#   stage: test
#   script:
#     - source $MODULE_LOAD_SCRIPT
#     - *setup_build_dir
#     - cmake $CMAKE_FLAGS ..
#     - *make
#     - *make_coverage
#     - *cleanup
#   artifacts:
#     when: always
#     paths:
#     - $BUILD_DIR/FORCES_coverage_CI.info
#     - $BUILD_DIR/FORCES_coverage_CI

# ##################
# ### BUILD JOBS ###
# ##################

# ######################
# ### ANALYTICS JOBS ###
# #####################

# #################
# ### TEST JOBS ###
# #################

# # NAG fails on lightweight_lib
# test-nag62-debug:
#   needs:
#     - job: build-nag62-debug
#       artifacts: true
#   variables:
#     <<: *debug_vars
#     MODULE_LOAD_SCRIPT: hpc-module-loads/eve.nagfor62
#     CMAKE_FLAGS: '-DCMAKE_FIND_LIBRARY_CUSTOM_LIB_SUFFIX=64 -DCMAKE_BUILD_TYPE=Debug'
#   <<: *test_template

test-nag62-release:
  variables:
    <<: *release_vars
    MODULE_LOAD_SCRIPT: hpc-module-loads/eve.nagfor62
    CMAKE_FLAGS: '-DBUILD_TESTING=ON -DCMAKE_FIND_LIBRARY_CUSTOM_LIB_SUFFIX=64 -DCMAKE_BUILD_TYPE=Release'
  <<: *test_template

test-gfortran83MPI-release:
  variables:
    <<: *release_vars
    MODULE_LOAD_SCRIPT: hpc-module-loads/eve.gfortran83MPI
    CMAKE_FLAGS: '-DBUILD_TESTING=ON -DCMAKE_BUILD_TYPE=Release'
  <<: *test_template

test-gfortran83MPI-debug:
  variables:
    <<: *debug_vars
    MODULE_LOAD_SCRIPT: hpc-module-loads/eve.gfortran83MPI
    CMAKE_FLAGS: '-DBUILD_TESTING=ON -DCMAKE_BUILD_TYPE=Debug'
  <<: *test_template

test-gfortran102MPI-release:
  variables:
    <<: *release_vars
    MODULE_LOAD_SCRIPT: hpc-module-loads/eve.gfortran102MPI
    CMAKE_FLAGS: '-DBUILD_TESTING=ON -DCMAKE_BUILD_TYPE=Release'
  <<: *test_template

test-gfortran102MPI-debug:
  variables:
    <<: *debug_vars
    MODULE_LOAD_SCRIPT: hpc-module-loads/eve.gfortran102MPI
    CMAKE_FLAGS: '-DBUILD_TESTING=ON -DCMAKE_BUILD_TYPE=Debug'
  <<: *test_template

test-gfortran73MPI-release:
  variables:
    <<: *release_vars
    MODULE_LOAD_SCRIPT: hpc-module-loads/eve.gfortran73MPI
    CMAKE_FLAGS: '-DBUILD_TESTING=ON -DCMAKE_BUILD_TYPE=Release'
  <<: *test_template

test-gfortran73MPI-debug:
  variables:
    <<: *debug_vars
    MODULE_LOAD_SCRIPT: hpc-module-loads/eve.gfortran73MPI
    CMAKE_FLAGS: '-DBUILD_TESTING=ON -DCMAKE_BUILD_TYPE=Debug'
  <<: *test_template

test-intel18-release:
  variables:
    <<: *release_vars
    MODULE_LOAD_SCRIPT: hpc-module-loads/eve.intel18
    CMAKE_FLAGS: '-DBUILD_TESTING=ON -DCMAKE_BUILD_TYPE=Release'
  <<: *test_template

test-intel18-debug:
  variables:
    <<: *debug_vars
    MODULE_LOAD_SCRIPT: hpc-module-loads/eve.intel18
    CMAKE_FLAGS: '-DBUILD_TESTING=ON -DCMAKE_BUILD_TYPE=Debug'
  <<: *test_template

test-intel19-release:
  variables:
    <<: *release_vars
    MODULE_LOAD_SCRIPT: hpc-module-loads/eve.intel19
    CMAKE_FLAGS: '-DBUILD_TESTING=ON -DCMAKE_BUILD_TYPE=Release'
  <<: *test_template

test-intel19MPI-release:
  variables:
    <<: *release_vars
    MODULE_LOAD_SCRIPT: hpc-module-loads/eve.intel19MPI
    CMAKE_FLAGS: '-DBUILD_TESTING=ON -DCMAKE_BUILD_TYPE=Release'
  <<: *test_template

# Coverage fails due to a gcov complication
# coverage-gcc73:
#   variables:
#     <<: *debug_vars
#     <<: *coverage_vars
#     MODULE_LOAD_SCRIPT: hpc-module-loads/eve.gfortran73MPI
#     CMAKE_FLAGS: '-DBUILD_TESTING=ON -DCMAKE_BUILD_TYPE=Debug -DCMAKE_WITH_COVERAGE=ON'
#   <<: *coverage_template

# ###################
# ### DEPLOY JOBS ###
# ###################

pages:
  when: always
  only:
    - develop
  stage: deploy
  needs:
    - job: documentation
      artifacts: true
  script:
    # create public dir (remove if already present)
    - test -d public && rm -rf public
    - mkdir -p public
    # create the subdir
    - mkdir public/stable/
    - mkdir public/latest/
    # copy the doxygen generated html page to the public site
    - cp html_mas/* public/stable/ -R
    - cp html_dev/* public/latest/ -R
    # create an index.html that redirects to the master documentation (in master folder)
    - cp doc/html_files/index.html public/
  artifacts:
    name: "$CI_COMMIT_REF_NAME"
    paths:
      - public
  when: always
